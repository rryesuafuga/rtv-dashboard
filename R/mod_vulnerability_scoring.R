


# R/mod_vulnerability_scoring.R - Vulnerability Scoring Module

#' vulnerability_scoring UI Function
#'
#' @description Household vulnerability assessment and scoring module
#' @param id,input,output,session Internal parameters for {shiny}.
#' @noRd 
#' @importFrom shiny NS tagList 
mod_vulnerability_scoring_ui <- function(id) {
  ns <- NS(id)
  tagList(
    # Controls row
    fluidRow(
      box(
        width = 12,
        title = "Vulnerability Assessment Controls",
        status = "primary",
        solidHeader = FALSE,
        collapsible = TRUE,
        
        fluidRow(
          column(3,
                 selectInput(ns("district_filter"), 
                             "Select District:",
                             choices = c("All Districts" = "all"),
                             selected = "all",
                             multiple = TRUE)
          ),
          column(3,
                 sliderInput(ns("vulnerability_range"),
                             "Vulnerability Score Range:",
                             min = 0, max = 100, value = c(0, 100),
                             step = 5)
          ),
          column(3,
                 selectInput(ns("program_phase_filter"),
                             "Program Phase:",
                             choices = c("All Phases" = "all",
                                         "Baseline" = "Baseline",
                                         "Active" = "Active", 
                                         "Graduated" = "Graduated"),
                             selected = "all")
          ),
          column(3,
                 br(),
                 actionButton(ns("update_analysis"), 
                              "Update Analysis",
                              icon = icon("refresh"),
                              class = "btn-success btn-block")
          )
        )
      )
    ),
    
    # Main content
    fluidRow(
      # Vulnerability distribution
      box(
        width = 6,
        title = "Vulnerability Score Distribution",
        status = "warning",
        solidHeader = TRUE,
        plotlyOutput(ns("vulnerability_histogram"), height = 400)
      ),
      
      # Risk factors
      box(
        width = 6,
        title = "Top Risk Factors",
        status = "danger",
        solidHeader = TRUE,
        plotlyOutput(ns("risk_factors_chart"), height = 400)
      )
    ),
    
    # Detailed analysis row
    fluidRow(
      # Heatmap
      box(
        width = 8,
        title = "District-Level Vulnerability Heatmap",
        status = "info",
        solidHeader = TRUE,
        plotlyOutput(ns("vulnerability_heatmap"), height = 450)
      ),
      
      # Statistics
      box(
        width = 4,
        title = "Key Statistics",
        status = "success",
        solidHeader = TRUE,
        
        tags$div(class = "vulnerability-stats",
                 uiOutput(ns("key_stats"))
        )
      )
    ),
    
    # ML Model predictions
    fluidRow(
      box(
        width = 12,
        title = "Machine Learning Model: Intervention Impact Predictions",
        status = "primary",
        solidHeader = TRUE,
        collapsible = TRUE,
        
        tabsetPanel(
          tabPanel("Predictions",
                   br(),
                   plotlyOutput(ns("ml_predictions"), height = 400)
          ),
          tabPanel("Feature Importance",
                   br(),
                   plotlyOutput(ns("feature_importance"), height = 400)
          ),
          tabPanel("Model Performance",
                   br(),
                   fluidRow(
                     column(6, plotlyOutput(ns("confusion_matrix"), height = 350)),
                     column(6, plotlyOutput(ns("roc_curve"), height = 350))
                   )
          )
        )
      )
    ),
    
    # Individual household analysis
    fluidRow(
      box(
        width = 12,
        title = "Individual Household Analysis",
        status = "primary",
        solidHeader = TRUE,
        collapsible = TRUE,
        collapsed = TRUE,
        
        fluidRow(
          column(4,
                 selectInput(ns("household_select"),
                             "Select Household ID:",
                             choices = NULL)
          ),
          column(8,
                 uiOutput(ns("household_details"))
          )
        ),
        
        hr(),
        
        fluidRow(
          column(6,
                 plotlyOutput(ns("household_radar"), height = 300)
          ),
          column(6,
                 uiOutput(ns("intervention_recommendations"))
          )
        )
      )
    )
  )
}

#' vulnerability_scoring Server Functions
#' @noRd 
mod_vulnerability_scoring_server <- function(id, datasets) {
  moduleServer(id, function(input, output, session) {
    ns <- session$ns
    
    # Update district choices
    observe({
      req(datasets$household)
      districts <- unique(datasets$household$district)
      updateSelectInput(session, "district_filter",
                        choices = c("All Districts" = "all", 
                                    setNames(districts, districts)))
    })
    
    # Update household choices
    observe({
      req(filtered_data())
      household_ids <- unique(filtered_data()$household_id)
      updateSelectInput(session, "household_select",
                        choices = household_ids[1:min(100, length(household_ids))])
    })
    
    # Filtered data reactive
    filtered_data <- eventReactive(c(input$update_analysis, datasets$household), {
      req(datasets$household)
      
      data <- datasets$household
      
      # Apply filters
      if (!"all" %in% input$district_filter && !is.null(input$district_filter)) {
        data <- data %>% filter(district %in% input$district_filter)
      }
      
      data <- data %>%
        filter(vulnerability_score >= input$vulnerability_range[1],
               vulnerability_score <= input$vulnerability_range[2])
      
      if (input$program_phase_filter != "all") {
        data <- data %>% filter(program_phase == input$program_phase_filter)
      }
      
      data
    }, ignoreInit = FALSE)
    
    # Vulnerability histogram
    output$vulnerability_histogram <- renderPlotly({
      req(filtered_data())
      
      p <- plot_ly(
        data = filtered_data(),
        x = ~vulnerability_score,
        type = 'histogram',
        nbinsx = 25,
        marker = list(
          color = ~cut(vulnerability_score, 
                       breaks = c(0, 30, 60, 100),
                       labels = c("Low", "Medium", "High")),
          colorscale = list(
            c(0, '#4CAF50'),
            c(0.5, '#FF9800'),
            c(1, '#F44336')
          ),
          line = list(color = 'white', width = 1)
        ),
        hovertemplate = 'Score Range: %{x}<br>Count: %{y}<extra></extra>'
      ) %>%
        layout(
          xaxis = list(title = "Vulnerability Score (0-100)"),
          yaxis = list(title = "Number of Households"),
          showlegend = FALSE,
          font = list(family = "Inter, sans-serif")
        )
      
      p
    })
    
    # Risk factors chart
    output$risk_factors_chart <- renderPlotly({
      req(filtered_data())
      
      # Calculate risk factor contributions
      risk_data <- filtered_data() %>%
        summarise(
          `No Water Access` = sum(!has_safe_water_access) / n() * 100,
          `No Latrine` = sum(!has_latrine) / n() * 100,
          `Female Headed` = sum(female_headed) / n() * 100,
          `No Improved Seeds` = sum(!uses_improved_seeds) / n() * 100,
          `No VSLA` = sum(!has_vsla_membership) / n() * 100,
          `Low Income` = sum(current_income_usd_daily < 1) / n() * 100
        ) %>%
        pivot_longer(everything(), names_to = "factor", values_to = "percentage")
      
      plot_ly(
        risk_data,
        x = ~percentage,
        y = ~reorder(factor, percentage),
        type = 'bar',
        orientation = 'h',
        marker = list(
          color = ~percentage,
          colorscale = list(
            c(0, '#4CAF50'),
            c(0.5, '#FF9800'),
            c(1, '#F44336')
          ),
          showscale = FALSE
        ),
        text = ~paste0(round(percentage, 1), "%"),
        textposition = 'outside',
        hovertemplate = '%{y}<br>%{x:.1f}% of households<extra></extra>'
      ) %>%
        layout(
          xaxis = list(title = "Percentage of Households", range = c(0, 100)),
          yaxis = list(title = ""),
          margin = list(l = 150),
          font = list(family = "Inter, sans-serif")
        )
    })
    
    # Vulnerability heatmap
    output$vulnerability_heatmap <- renderPlotly({
      req(filtered_data())
      
      # Create matrix data for heatmap
      heatmap_data <- filtered_data() %>%
        mutate(
          income_category = cut(current_income_usd_daily,
                               breaks = c(0, 0.5, 1, 1.5, 2, Inf),
                               labels = c("<$0.50", "$0.50-1", "$1-1.50", 
                                        "$1.50-2", ">$2"))
        ) %>%
        group_by(district, income_category) %>%
        summarise(
          avg_vulnerability = mean(vulnerability_score, na.rm = TRUE),
          count = n(),
          .groups = "drop"
        ) %>%
        complete(district, income_category, fill = list(avg_vulnerability = NA, count = 0))
      
      # Create matrix - handle duplicate districts by aggregating
      matrix_prep <- heatmap_data %>%
        group_by(district, income_category) %>%
        summarise(avg_vulnerability = mean(avg_vulnerability, na.rm = TRUE), .groups = "drop") %>%
        pivot_wider(names_from = income_category, 
                   values_from = avg_vulnerability,
                   values_fill = 0)
      
      # Extract row names and matrix separately
      row_names <- matrix_prep$district
      matrix_data <- as.matrix(matrix_prep[, -1])
      
      plot_ly(
        z = matrix_data,
        x = colnames(matrix_data),
        y = row_names,
        type = "heatmap",
        colorscale = list(
          c(0, "#4CAF50"),
          c(0.5, "#FFEB3B"),
          c(1, "#F44336")
        ),
        hovertemplate = "District: %{y}<br>Income: %{x}<br>Avg Score: %{z:.1f}<extra></extra>"
      ) %>%
        layout(
          xaxis = list(title = "Daily Income Category (USD)"),
          yaxis = list(title = "District"),
          font = list(family = "Inter, sans-serif")
        )
    })
    
    # Key statistics
    output$key_stats <- renderUI({
      req(filtered_data())
      
      data <- filtered_data()
      
      stats <- list(
        avg_score = mean(data$vulnerability_score, na.rm = TRUE),
        median_score = median(data$vulnerability_score, na.rm = TRUE),
        high_risk = sum(data$vulnerability_score > 70) / nrow(data) * 100,
        avg_household_size = mean(data$household_size, na.rm = TRUE),
        water_access = mean(data$has_safe_water_access, na.rm = TRUE) * 100,
        vsla_participation = mean(data$has_vsla_membership, na.rm = TRUE) * 100
      )
      
      tagList(
        tags$div(class = "stat-item",
                 tags$h4(round(stats$avg_score, 1)),
                 tags$p("Average Vulnerability Score")
        ),
        tags$div(class = "stat-item",
                 tags$h4(paste0(round(stats$high_risk, 1), "%")),
                 tags$p("High Risk Households")
        ),
        tags$div(class = "stat-item",
                 tags$h4(round(stats$avg_household_size, 1)),
                 tags$p("Avg Household Size")
        ),
        tags$div(class = "stat-item",
                 tags$h4(paste0(round(stats$water_access, 1), "%")),
                 tags$p("Water Access Rate")
        ),
        tags$div(class = "stat-item",
                 tags$h4(paste0(round(stats$vsla_participation, 1), "%")),
                 tags$p("VSLA Participation")
        ),
        
        # CSS for stat items
        tags$style(HTML("
          .stat-item {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
          }
          .stat-item h4 {
            color: #2E7D32;
            font-size: 28px;
            font-weight: 700;
            margin: 0;
          }
          .stat-item p {
            color: #666;
            margin: 5px 0 0 0;
            font-size: 14px;
          }
        "))
      )
    })
    
    # ML predictions (simulated)
    output$ml_predictions <- renderPlotly({
      req(filtered_data())
      
      # Simulate predictions
      set.seed(123)
      data <- filtered_data() %>%
        mutate(
          predicted_improvement = pmax(0, 100 - vulnerability_score + 
                                         rnorm(n(), mean = 10, sd = 5)),
          actual_improvement = ifelse(
            program_phase == "Graduated",
            pmax(0, 100 - vulnerability_score + rnorm(n(), mean = 8, sd = 7)),
            NA
          )
        )
      
      # Create scatter plot
      plot_ly(data) %>%
        add_trace(
          x = ~vulnerability_score,
          y = ~predicted_improvement,
          type = 'scatter',
          mode = 'markers',
          name = 'Predicted',
          marker = list(
            size = 8,
            color = '#2196F3',
            opacity = 0.6
          ),
          hovertemplate = 'Vulnerability: %{x}<br>Predicted Improvement: %{y:.1f}%<extra></extra>'
        ) %>%
        add_trace(
          data = filter(data, !is.na(actual_improvement)),
          x = ~vulnerability_score,
          y = ~actual_improvement,
          type = 'scatter',
          mode = 'markers',
          name = 'Actual (Graduated)',
          marker = list(
            size = 8,
            color = '#4CAF50',
            opacity = 0.6
          ),
          hovertemplate = 'Vulnerability: %{x}<br>Actual Improvement: %{y:.1f}%<extra></extra>'
        ) %>%
        layout(
          xaxis = list(title = "Initial Vulnerability Score"),
          yaxis = list(title = "Improvement Potential (%)"),
          font = list(family = "Inter, sans-serif"),
          showlegend = TRUE
        )
    })
    
    # Feature importance (simulated)
    output$feature_importance <- renderPlotly({
      features <- data.frame(
        feature = c("Water Access", "Income Level", "VSLA Membership", 
                    "Female Headed", "Household Size", "Land Size",
                    "Uses Improved Seeds", "Has Latrine", "Education Level",
                    "Distance to Market"),
        importance = c(0.22, 0.18, 0.15, 0.12, 0.08, 0.07, 0.06, 0.05, 0.04, 0.03)
      )
      
      plot_ly(
        features,
        x = ~importance,
        y = ~reorder(feature, importance),
        type = 'bar',
        orientation = 'h',
        marker = list(color = '#2E7D32'),
        text = ~paste0(round(importance * 100, 1), "%"),
        textposition = 'outside',
        hovertemplate = '%{y}<br>Importance: %{x:.1%}<extra></extra>'
      ) %>%
        layout(
          xaxis = list(title = "Feature Importance", tickformat = '.0%'),
          yaxis = list(title = ""),
          margin = list(l = 150),
          font = list(family = "Inter, sans-serif")
        )
    })
    
    # Individual household analysis
    output$household_radar <- renderPlotly({
      req(input$household_select, filtered_data())
      
      household <- filtered_data() %>%
        filter(household_id == input$household_select) %>%
        slice(1)
      
      if (nrow(household) == 0) return(NULL)
      
      # Create radar chart data
      categories <- c("Water Access", "Sanitation", "Income", 
                      "Agriculture", "Financial", "Education")
      
      values <- c(
        household$has_safe_water_access * 100,
        household$has_latrine * 100,
        min(100, household$current_income_usd_daily / 2 * 100),
        household$uses_improved_seeds * 100,
        household$has_vsla_membership * 100,
        runif(1, 20, 80)  # Simulated education score
      )
      
      plot_ly(
        type = 'scatterpolar',
        r = values,
        theta = categories,
        fill = 'toself',
        fillcolor = 'rgba(46, 125, 50, 0.3)',
        line = list(color = '#2E7D32'),
        hovertemplate = '%{theta}<br>Score: %{r}<extra></extra>'
      ) %>%
        layout(
          polar = list(
            radialaxis = list(
              visible = TRUE,
              range = c(0, 100)
            )
          ),
          font = list(family = "Inter, sans-serif"),
          showlegend = FALSE
        )
    })
    
    # Intervention recommendations
    output$intervention_recommendations <- renderUI({
      req(input$household_select, filtered_data())
      
      household <- filtered_data() %>%
        filter(household_id == input$household_select) %>%
        slice(1)
      
      if (nrow(household) == 0) return(NULL)
      
      recommendations <- list()
      
      if (!household$has_safe_water_access) {
        recommendations <- append(recommendations, 
                                  "ðŸš° Priority: Establish safe water access within 1km")
      }
      if (!household$has_vsla_membership) {
        recommendations <- append(recommendations, 
                                  "ðŸ’° Enroll in Village Savings and Loan Association")
      }
      if (!household$uses_improved_seeds) {
        recommendations <- append(recommendations, 
                                  "ðŸŒ± Provide training and access to improved seeds")
      }
      if (household$current_income_usd_daily < 1) {
        recommendations <- append(recommendations, 
                                  "ðŸ“ˆ Intensive income generation support needed")
      }
      
      tagList(
        h4("Recommended Interventions:"),
        tags$ul(
          lapply(recommendations, function(r) tags$li(r))
        ),
        br(),
        tags$div(
          class = "alert alert-info",
          tags$strong("Predicted Impact: "),
          "With full intervention package, vulnerability score could decrease by ",
          tags$strong(paste0(round(runif(1, 25, 45)), "%")),
          " within 24 months."
        )
      )
    })
    
    # Household details
    output$household_details <- renderUI({
      req(input$household_select, filtered_data())
      
      household <- filtered_data() %>%
        filter(household_id == input$household_select) %>%
        slice(1)
      
      if (nrow(household) == 0) return(NULL)
      
      tagList(
        tags$div(
          class = "household-details",
          tags$p(tags$strong("District: "), household$district),
          tags$p(tags$strong("Village: "), household$village),
          tags$p(tags$strong("Household Size: "), household$household_size),
          tags$p(tags$strong("Current Income: "), 
                 paste0("$", round(household$current_income_usd_daily, 2), "/day")),
          tags$p(tags$strong("Vulnerability Score: "), 
                 tags$span(
                   style = paste0("color: ", ifelse(household$vulnerability_score > 70, 
                                                    "#F44336", "#4CAF50")),
                   household$vulnerability_score
                 ))
        )
      )
    })
  })
}


